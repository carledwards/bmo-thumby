import time
import thumby
import math
import random

thumby.display.fill(1)

# BITMAP: width: 72, height: 40
normalFaceBitmap = bytearray([255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
           255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,199,131,131,131,199,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,199,131,131,131,199,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
           255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,127,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
           255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,253,253,253,253,251,251,251,251,251,253,253,254,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
           255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255])
# BITMAP: width: 72, height: 40
blinkingFaceBitmap = bytearray([255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
           255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,207,231,231,231,207,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,207,231,231,231,207,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
           255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,127,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
           255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,253,253,253,253,251,251,251,251,251,253,253,254,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
           255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255])

# BITMAP: width: 72, height: 40
openMouthFaceBitmap = bytearray([255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
           255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,131,1,1,1,131,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,131,1,1,1,131,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
           255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,63,63,63,63,63,63,63,63,63,63,63,63,63,63,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
           255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,254,252,252,248,248,248,248,248,248,252,252,254,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
           255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255])

# BITMAP: width: 72, height: 40
smilingFaceBitmap = bytearray([255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
            255,255,255,255,255,255,255,255,255,255,255,255,255,255,191,223,239,239,239,223,191,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,191,223,239,239,239,223,191,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
            255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,241,207,191,127,127,255,255,255,255,127,127,191,207,241,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
            255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,254,254,254,254,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
            255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255])

# BITMAP: width: 13, height: 13
heartBitmap = bytearray([193,128,0,0,0,1,7,1,0,0,0,128,193,
           31,31,31,30,28,24,16,24,28,30,31,31,31])
           
normalFace = thumby.Sprite(72, 40, normalFaceBitmap)
blinkingFace = thumby.Sprite(72, 40, blinkingFaceBitmap)
openMouthFace = thumby.Sprite(72, 40, openMouthFaceBitmap)
smilingFace = thumby.Sprite(72, 40, smilingFaceBitmap)

inAnimation = False
nextBlinkDeadline = 0

heartSprites = []
currentFace = None

animateHeartDelay = 0

def addHeart():
    heart = thumby.Sprite(13,13, heartBitmap)
    heart.x = random.randint(5,67) # between a left/right margin
    heart.y = 46 # bottom of the screen
    heartSprites.append(heart)

def updateScreen():
    global heartSprites, animateHeartDelay

    # drawing the face is the bottom of the visuals
    if currentFace:
        thumby.display.drawSprite(currentFace)

    if animateHeartDelay > 2:
        # calculate the location for the any sprites
        for sprite in heartSprites:
            sprite.y = sprite.y -1
            sprite.x = sprite.x + random.randint(-1,1)
        animateHeartDelay = 0
    else:
        animateHeartDelay = animateHeartDelay + 1

    # keep the sprites that are still in view
    updatedList = []
    for sprite in heartSprites:
        if sprite.y > -5: # still visible
            updatedList.append(sprite)
            thumby.display.drawSprite(sprite)

    heartSprites = updatedList
    thumby.display.update()

def showFaceSprite(sprite):
    global currentFace
    currentFace = sprite
    sprite.x = 0
    sprite.y = 0
    updateScreen()
    
def resetBlinkTime():
    global nextBlinkDeadline
    nextBlinkDeadline = time.ticks_add(time.ticks_ms(), random.randint(3000,6000))
    
def blink():
    blinkInterrupted = False
    showFaceSprite(blinkingFace)
    blinkDoneDeadline = time.ticks_add(time.ticks_ms(), random.randint(10,40)*10)
    while not blinkInterrupted and time.ticks_diff(blinkDoneDeadline, time.ticks_ms()) > 0:
        if thumby.inputJustPressed():
            blinkInterrupted = True
    resetBlinkTime()
    return blinkInterrupted

# initialize first blink time
resetBlinkTime()

while True:
    if inAnimation == False:
        if thumby.inputJustPressed():
            inAnimation = True
            continue

        if time.ticks_diff(nextBlinkDeadline, time.ticks_ms()) < 0:
            if blink():
                inAnimation = True
                continue

        showFaceSprite(normalFace)

    else:
        addHeart()

        showFaceSprite(openMouthFace)
        openMouthDeadline = time.ticks_add(time.ticks_ms(), random.randint(25,40)*10)
        while time.ticks_diff(openMouthDeadline, time.ticks_ms()) > 0:
            updateScreen()
            if thumby.inputJustPressed():
                addHeart()
                continue

        showFaceSprite(smilingFace)
        smileDeadline = time.ticks_add(time.ticks_ms(), 1250)
        while time.ticks_diff(smileDeadline, time.ticks_ms()) > 0:
            updateScreen()
            if thumby.inputJustPressed():
                addHeart()
                smileDeadline = time.ticks_add(smileDeadline, 100)
                continue
            
        inAnimation = False
        resetBlinkTime()
